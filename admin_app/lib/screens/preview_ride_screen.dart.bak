import 'package:flutter/material.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import '../models/place.dart';
import '../models/price.dart';
import '../utils/app_theme.dart';
import 'package:intl/intl.dart' as intl;
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'dart:math';

class PreviewRideScreen extends StatefulWidget {
  final String customerName;
  final String customerPhone;
  final Place pickupLocation;
  final Place? dropoffLocation;
  final bool isOpenRide;

  const PreviewRideScreen({
    super.key,
    required this.customerName,
    required this.customerPhone,
    required this.pickupLocation,
    this.dropoffLocation,
    required this.isOpenRide,
  });

  @override
  State<PreviewRideScreen> createState() => _PreviewRideScreenState();
}

class _PreviewRideScreenState extends State<PreviewRideScreen> {
  final GlobalKey<FormState> _formKey = GlobalKey<FormState>();
  
  GoogleMapController? _mapController;
  Set<Marker> _markers = {};
  Set<Polyline> _polylines = {};
  bool _isLoading = false;
  bool _isSending = false;
  String? _error;
  
  double _distance = 0;
  double _duration = 0;
  double _fare = 0;
  Price? _currentPrice;

  final TextEditingController _pickupNameController = TextEditingController();
  final TextEditingController _dropoffNameController = TextEditingController();
  final TextEditingController _fareController = TextEditingController();
  final TextEditingController _distanceController = TextEditingController();

  bool _isPickupEdited = false;
  bool _isDropoffEdited = false;
  bool _isFareEdited = false;
  bool _isDistanceEdited = false;

  @override
  void initState() {
    super.initState();
    _initializeData();
  }

  Future<void> _initializeData() async {
    setState(() => _isLoading = true);
    try {
      _initializeControllers();
      await _loadCurrentPrice();
      await _setupMapAndCalculateDistance();
    } catch (e) {
      setState(() => _error = e.toString());
    } finally {
      setState(() => _isLoading = false);
    }
  }

  void _initializeControllers() {
    _pickupNameController.text = widget.pickupLocation.name;
    if (widget.dropoffLocation != null) {
      _dropoffNameController.text = widget.dropoffLocation!.name;
    }
  }

  @override
  void dispose() {
    _mapController?.dispose();
    _pickupController.dispose();
    _dropoffController.dispose();
    _fareController.dispose();
    super.dispose();
  }

  Future<void> _initializeScreen() async {
    setState(() => _isLoading = true);
    try {
      await _loadCurrentPrice();
      await _initializeMap();
      if (widget.dropoffLocation != null) {
        await _calculateRouteAndFare();
      }
    } catch (e) {
      setState(() => _error = e.toString());
    } finally {
      setState(() => _isLoading = false);
    }
  }

  Future<void> _loadCurrentPrice() async {
    try {
      final priceQuery = await FirebaseFirestore.instance
          .collection('prices')
          .where('isActive', isEqualTo: true)
          .orderBy('lastUpdated', descending: true)
          .limit(1)
          .get();

      if (priceQuery.docs.isNotEmpty) {
        final data = priceQuery.docs.first.data() as Map<String, dynamic>;
        _currentPrice = Price.fromMap(data, priceQuery.docs.first.id);
      } else {
        throw Exception('لم يتم العثور على تسعيرة نشطة');
      }
    } catch (e) {
      throw Exception('خطأ في تحميل التسعيرة: $e');
    }
  }

  Future<void> _initializeMap() async {
    final markers = {
      Marker(
        markerId: const MarkerId('pickup'),
        position: LatLng(
          widget.pickupLocation.location.latitude,
          widget.pickupLocation.location.longitude,
        ),
        icon: BitmapDescriptor.defaultMarkerWithHue(BitmapDescriptor.hueGreen),
        infoWindow: InfoWindow(title: _pickupName),
      ),
    };

    if (widget.dropoffLocation != null) {
      markers.add(
        Marker(
          markerId: const MarkerId('dropoff'),
          position: LatLng(
            widget.dropoffLocation!.location.latitude,
            widget.dropoffLocation!.location.longitude,
          ),
          icon: BitmapDescriptor.defaultMarkerWithHue(BitmapDescriptor.hueRed),
          infoWindow: InfoWindow(title: _dropoffName),
        ),
      );
    }

    setState(() => _markers = markers);
  }

  Future<void> _calculateRouteAndFare() async {
    if (widget.dropoffLocation == null) return;

    try {
      final distance = _calculateDistance(
        widget.pickupLocation.location.latitude,
        widget.pickupLocation.location.longitude,
        widget.dropoffLocation!.location.latitude,
        widget.dropoffLocation!.location.longitude,
      );

      final estimatedDuration = (distance / 40) * 60; // Assuming 40 km/h average speed
      await _fetchAndDisplayRoute();

      setState(() {
        _distance = distance;
        _duration = estimatedDuration;
      });

      _calculateFare();
    } catch (e) {
      throw Exception('خطأ في حساب المسار: $e');
    }
  }

  double _calculateDistance(double startLat, double startLng, double endLat, double endLng) {
    const double earthRadius = 6371; // km
    final double latDiff = _toRadians(endLat - startLat);
    final double lngDiff = _toRadians(endLng - startLng);

    final double a = sin(latDiff / 2) * sin(latDiff / 2) +
        cos(_toRadians(startLat)) *
            cos(_toRadians(endLat)) *
            sin(lngDiff / 2) *
            sin(lngDiff / 2);

    final double c = 2 * atan2(sqrt(a), sqrt(1 - a));
    return earthRadius * c;
  }

  double _toRadians(double degree) {
    return degree * (pi / 180);
  }

  Future<void> _fetchAndDisplayRoute() async {
    try {
      final String apiKey = 'YOUR_GOOGLE_MAPS_API_KEY';
      final String baseUrl = 'https://maps.googleapis.com/maps/api/directions/json';
      final String url = '$baseUrl?origin=${widget.pickupLocation.location.latitude},${widget.pickupLocation.location.longitude}'
          '&destination=${widget.dropoffLocation!.location.latitude},${widget.dropoffLocation!.location.longitude}'
          '&key=$apiKey';

      final response = await http.get(Uri.parse(url));

      if (response.statusCode == 200) {
        final data = json.decode(response.body);
        if (data['status'] == 'OK') {
          final points = _decodePolyline(data['routes'][0]['overview_polyline']['points']);
          
          setState(() {
            _polylines = {
              Polyline(
                polylineId: const PolylineId('route'),
                points: points,
                color: AppColors.primary,
                width: 4,
              ),
            };
          });

          _adjustCameraToBounds(points);
        }
      }
    } catch (e) {
      debugPrint('Error fetching route: $e');
    }
  }

  List<LatLng> _decodePolyline(String encoded) {
    List<LatLng> points = [];
    int index = 0, len = encoded.length;
    int lat = 0, lng = 0;

    while (index < len) {
      int b, shift = 0, result = 0;
      do {
        b = encoded.codeUnitAt(index++) - 63;
        result |= (b & 0x1f) << shift;
        shift += 5;
      } while (b >= 0x20);
      int dlat = ((result & 1) != 0 ? ~(result >> 1) : (result >> 1));
      lat += dlat;

      shift = 0;
      result = 0;
      do {
        b = encoded.codeUnitAt(index++) - 63;
        result |= (b & 0x1f) << shift;
        shift += 5;
      } while (b >= 0x20);
      int dlng = ((result & 1) != 0 ? ~(result >> 1) : (result >> 1));
      lng += dlng;

      points.add(LatLng(lat / 1E5, lng / 1E5));
    }
    return points;
  }

  void _adjustCameraToBounds(List<LatLng> points) {
    if (points.isEmpty || _mapController == null) return;

    double minLat = points.first.latitude;
    double maxLat = points.first.latitude;
    double minLng = points.first.longitude;
    double maxLng = points.first.longitude;

    for (LatLng point in points) {
      minLat = min(minLat, point.latitude);
      maxLat = max(maxLat, point.latitude);
      minLng = min(minLng, point.longitude);
      maxLng = max(maxLng, point.longitude);
    }

    _mapController!.animateCamera(
      CameraUpdate.newLatLngBounds(
        LatLngBounds(
          southwest: LatLng(minLat, minLng),
          northeast: LatLng(maxLat, maxLng),
        ),
        100, // padding
      ),
    );
  }

  void _calculateFare() {
    if (_currentPrice == null) return;

    final hour = DateTime.now().hour;
    final isNightTime = hour >= 22 || hour < 6;

    if (widget.isOpenRide) {
      _fare = _currentPrice!.openRideBaseFare;
    } else {
      _fare = _currentPrice!.calculateRegularRideFare(_distance, isNightTime);
    }

    _customFare = _fare;
    _fareController.text = _fare.toString();
  }

  Future<void> _sendRide() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() {
      _isSending = true;
      _error = null;
    });

    try {
      String customerId = await _getOrCreateCustomer();

      final ridesRef = FirebaseFirestore.instance.collection('rides');
      final lastRideDoc = await ridesRef.orderBy('index', descending: true).limit(1).get();
      final lastIndex = lastRideDoc.docs.isEmpty ? 0 : lastRideDoc.docs.first.data()['index'] ?? 0;

      await ridesRef.add({
        'index': lastIndex + 1,
        'customerName': widget.customerName,
        'customerPhone': widget.customerPhone,
        'customerId': customerId,
        'pickupAddress': _isPickupEdited ? _pickupName : widget.pickupLocation.name,
        'pickupLocation': GeoPoint(
          widget.pickupLocation.location.latitude,
          widget.pickupLocation.location.longitude,
        ),
        'dropoffAddress': _isDropoffEdited ? _dropoffName : widget.dropoffLocation?.name,
        'dropoffLocation': widget.dropoffLocation != null
            ? GeoPoint(
                widget.dropoffLocation!.location.latitude,
                widget.dropoffLocation!.location.longitude,
              )
            : null,
        'isOpenRide': widget.isOpenRide,
        'status': 'pending',
        'createdAt': Timestamp.now(),
        'fare': _isFareEdited ? _customFare : _fare,
        'distance': _distance,
        'duration': _duration,
        'city': widget.pickupLocation.cityId,
        'priceId': _currentPrice!.id,
        'priceDetails': _currentPrice!.toMap(),
      });

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('تم إرسال الطلب بنجاح'),
            backgroundColor: AppColors.success,
          ),
        );
        Navigator.pop(context, true);
      }
    } catch (e) {
      setState(() => _error = e.toString());
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('حدث خطأ: $_error'),
          backgroundColor: AppColors.error,
        ),
      );
    } finally {
      setState(() => _isSending = false);
    }
  }

  Future<String> _getOrCreateCustomer() async {
    try {
      final customersRef = FirebaseFirestore.instance.collection('customers');
      final customerQuery = await customersRef
          .where('phone', isEqualTo: widget.customerPhone)
          .limit(1)
          .get();

      if (customerQuery.docs.isNotEmpty) {
        return customerQuery.docs.first.id;
      }

      final newCustomerDoc = await customersRef.add({
        'name': widget.customerName,
        'phone': widget.customerPhone,
        'createdAt': Timestamp.now(),
        'ridesCount': 0,
        'rating': 5.0,
        'totalSpent': 0,
      });

      return newCustomerDoc.id;
    } catch (e) {
      throw Exception('خطأ في إنشاء/البحث عن العميل: $e');
    }
  }

  Widget _buildMap() {
    return SizedBox(
      height: 200,
      child: GoogleMap(
        initialCameraPosition: CameraPosition(
          target: LatLng(
            widget.pickupLocation.location.latitude,
            widget.pickupLocation.location.longitude,
          ),
          zoom: 15,
        ),
        markers: _markers,
        polylines: _polylines,
        onMapCreated: (controller) => _mapController = controller,
        myLocationEnabled: false,
        zoomControlsEnabled: false,
        mapToolbarEnabled: false,
      ),
    );
  }

  Widget _buildCustomerInfo() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceVariant,
        border: Border(bottom: BorderSide(color: AppColors.border)),
      ),
      child: Row(
        children: [
          CircleAvatar(
            backgroundColor: AppColors.primary.withOpacity(0.1),
            child: Icon(Icons.person_outline, color: AppColors.primary),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  widget.customerName,
                  style: AppTextStyles.arabicBody.copyWith(
                    fontWeight: FontWeight.bold,
                  ),
                ),
                Text(
                  widget.customerPhone,
                  style: AppTextStyles.arabicBodySmall.copyWith(
                    color: AppColors.textSecondary,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildLocationFields() {
    return Padding(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          TextFormField(
            controller: _pickupController,
            decoration: InputDecoration(
              labelText: 'موقع الانطلاق',
              prefixIcon: Icon(Icons.location_on, color: AppColors.primary),
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
            validator: (value) {
              if (value?.isEmpty ?? true) {
                return 'يرجى إدخال موقع الانطلاق';
              }
              return null;
            },
            onChanged: (value) {
              setState(() {
                _pickupName = value;
                _isPickupEdited = true;
              });
            },
          ),
          if (!widget.isOpenRide) ...[
            const SizedBox(height: 16),
            TextFormField(
              controller: _dropoffController,
              decoration: InputDecoration(
                labelText: 'موقع الوصول',
                prefixIcon: Icon(Icons.location_on, color: AppColors.primary),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
              ),
              validator: (value) {
                if (!widget.isOpenRide && (value?.isEmpty ?? true)) {
                  return 'يرجى إدخال موقع الوصول';
                }
                return null;
              },
              onChanged: (value) {
                setState(() {
                  _dropoffName = value;
                  _isDropoffEdited = true;
                });
              },
            ),
          ],
        ],
      ),
    );
  }

  Widget _buildFareSection() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceVariant,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'تفاصيل الرحلة',
            style: AppTextStyles.arabicTitle,
          ),
          const SizedBox(height: 16),
          if (!widget.isOpenRide) ...[
            _buildDetailRow('المسافة', '${_distance.toStringAsFixed(1)} كم'),
            _buildDetailRow('الوقت المتوقع', '${_duration.toStringAsFixed(0)} دقيقة'),
          ],
          const SizedBox(height: 16),
          Row(
            children: [
              Expanded(
                child: TextFormField(
                  controller: _fareController,
                  keyboardType: TextInputType.number,
                  decoration: InputDecoration(
                    labelText: 'السعر',
                    suffixText: 'MRU',
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  validator: (value) {
                    if (value?.isEmpty ?? true) {
                      return 'يرجى إدخال السعر';
                    }
                    if (double.tryParse(value!) == null) {
                      return 'يرجى إدخال رقم صحيح';
                    }
                    return null;
                  },
                  onChanged: (value) {
                    setState(() {
                      _customFare = double.tryParse(value) ?? _fare;
                      _isFareEdited = true;
                    });
                  },
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildDetailRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            label,
            style: AppTextStyles.arabicBodySmall.copyWith(
              color: AppColors.textSecondary,
            ),
          ),
          Text(
            value,
            style: AppTextStyles.arabicBody.copyWith(
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(
          widget.isOpenRide ? 'رحلة مفتوحة' : 'معاينة الرحلة',
          style: AppTextStyles.arabicTitle.copyWith(
            color: AppColors.surface,
          ),
        ),
        backgroundColor: AppColors.primary,
        centerTitle: true,
      ),
      body: _isLoading
          ? Center(child: CircularProgressIndicator(color: AppColors.primary))
          : Form(
              key: _formKey,
              child: ListView(
                children: [
                  _buildMap(),
                  _buildCustomerInfo(),
                  _buildLocationFields(),
                  const SizedBox(height: 16),
                  _buildFareSection(),
                  if (_error != null)
                    Padding(
                      padding: const EdgeInsets.all(16),
                      child: Text(
                        _error!,
                        style: AppTextStyles.arabicBody.copyWith(
                          color: AppColors.error,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ),
                  Padding(
                    padding: const EdgeInsets.all(16),
                    child: ElevatedButton(
                      onPressed: _isSending ? null : _sendRide,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primary,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: _isSending
                          ? SizedBox(
                              height: 20,
                              width: 20,
                              child: CircularProgressIndicator(
                                strokeWidth: 2,
                                color: AppColors.surface,
                              ),
                            )
                          : Text(
                              'إرسال الطلب',
                              style: AppTextStyles.arabicBody.copyWith(
                                color: AppColors.surface,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                    ),
                  ),
                ],
              ),
            ),
    );
  }
}
